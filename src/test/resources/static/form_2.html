<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Khám Bệnh</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            margin: 50px auto;
        }
        .form-group label {
            font-weight: bold;
        }
        .btn-calculate {
            background-color: #28a745;
            color: white;
        }
        .btn-refresh {
            background-color: #ffc107;
            color: white;
        }
        .btn-exit {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="form-container">
        <h2 class="text-center text-primary mb-4">Đăng Ký Khám Bệnh</h2>
        <form id="registrationForm" novalidate>
            <div class="form-group">
                <label for="name">Họ Tên:</label>
                <input type="text" class="form-control" id="name" required minlength="3" maxlength="50" placeholder="Nhập họ tên">
                <div class="invalid-feedback">Họ tên phải có độ dài từ 3 đến 50 ký tự.</div>
            </div>
            <div class="form-group">
                <label for="address">Địa Chỉ:</label>
                <input type="text" class="form-control" id="address" required minlength="5" maxlength="100" placeholder="Nhập địa chỉ">
                <div class="invalid-feedback">Địa chỉ phải có độ dài từ 5 đến 100 ký tự.</div>
            </div>
            <div class="form-group">
                <label for="phone">Số Điện Thoại:</label>
                <input type="tel" class="form-control" id="phone" required pattern="^\d{10,15}$" placeholder="Nhập số điện thoại (10-15 chữ số)">
                <div class="invalid-feedback">Số điện thoại phải bao gồm 10-15 chữ số.</div>
            </div>
            <div class="form-group">
                <label for="cccd">Số CCCD:</label>
                <input type="text" class="form-control" id="cccd" required pattern="^\d{12}$" placeholder="Nhập số CCCD (12 chữ số)">
                <div class="invalid-feedback">Số CCCD phải gồm đúng 12 chữ số.</div>
            </div>
            <div class="form-group">
                <label>Giới Tính:</label>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="gender" id="male" value="Nam" required>
                    <label class="form-check-label" for="male">Nam</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="gender" id="female" value="Nữ">
                    <label class="form-check-label" for="female">Nữ</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="gender" id="child" value="Trẻ em">
                    <label class="form-check-label" for="child">Trẻ em</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="gender" id="elder" value="Người cao tuổi">
                    <label class="form-check-label" for="elder">Người cao tuổi</label>
                </div>
            </div>
            <div class="form-group">
                <label for="age">Tuổi:</label>
                <input type="number" class="form-control" id="age" required min="0" max="120" placeholder="Nhập tuổi (0-120)">
                <div class="invalid-feedback">Tuổi phải nằm trong khoảng 0-120.</div>
            </div>
            <div class="form-group">
                <label for="doctor">Chọn Bác Sĩ:</label>
                <select class="form-control" id="doctor" required>
                    <option value="">Chọn bác sĩ</option>
                    <option>Bác Sĩ 1</option>
                    <option>Bác Sĩ 2</option>
                    <option>Bác Sĩ 3</option>
                </select>
                <div class="invalid-feedback">Vui lòng chọn bác sĩ.</div>
            </div>
            <div class="form-group">
                <label for="appointment">Thời Gian Khám:</label>
                <input type="datetime-local" class="form-control" id="appointment" required value="now()">
                <div class="invalid-feedback">Vui lòng chọn thời gian khám.</div>
            </div>
            <div class="form-group">
                <label for="fee">Giá Tiền:</label>
                <input type="text" class="form-control" id="fee" value="VND" readonly>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-calculate" id="payment">Tính Tiền</button>
                <button type="reset" class="btn btn-refresh">Làm Mới</button>
                <button type="submit" class="btn btn-primary">Đăng Ký</button>
                <button type="button" class="btn btn-exit">Thoát</button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- jQuery and JavaScript -->
<script>
    // Get the current date and time
    const now = new Date();

    // Format the date and time to YYYY-MM-DDTHH:mm
    const formattedDate = now.toISOString().slice(0, 16); // Converts to ISO format and slices to get the required format

    // Set the default value for the appointment input
    document.getElementById("appointment").value = formattedDate;
    $(document).ready(function() {
        // Function to validate the name input
        function validateName(name) {
            name=name.strim();
            const namePattern = /^[a-zA-ZÀ-ÿ\s]+$/; // Accepts letters and spaces
            return namePattern.test(name);
        }

        // Function to validate the address input
        function validateAddress(address) {
            return address.trim() !== "" && address.length >= 5 && address.length <= 100;
        }

        // Function to validate the phone input
        function validatePhone(phone) {
            const phonePattern = /^(0[1-9]\d{3}\s?\d{3}\s?\d{3})$/; // Accepts phone numbers formatted with or without spaces
            return phonePattern.test(phone);
        }

        // Function to validate the CCCD input
        function validateCCCD(cccd) {
            const cccdPattern = /^\d{12}$/; // Only 12 digits
            return cccdPattern.test(cccd);
        }

        // Function to validate the age input
        function validateAge(age) {
            return age >= 0 && age <= 120; // Age must be between 0 and 120
        }

        // Function to calculate fee based on gender and age
        function calculateFee(gender, age) {
            let fee = 0;
            if (gender === "Nam") {
                if (age >= 17 && age <= 20) {
                    fee = 100;
                } else if (age >= 21 && age <= 30) {
                    fee = 120;
                } else if (age >= 31 && age <= 60) {
                    fee = 200;
                } else if (age > 60) {
                    fee = 250;
                } else {
                    return null; // Invalid age for "Nam"
                }
            } else if (gender === "Nữ") {
                if (age >= 17 && age <= 20) {
                    fee = 90;
                } else if (age >= 21 && age <= 30) {
                    fee = 120;
                } else if (age >= 31 && age <= 60) {
                    fee = 140;
                } else if (age > 60) {
                    fee = 150;
                } else {
                    return null; // Invalid age for "Nữ"
                }
            } else if (gender === "Trẻ em") {
                if (age >= 0 && age < 17) {
                    fee = 50;
                } else {
                    return null; // Invalid age for "Trẻ em"
                }
            } else if (gender === "Người cao tuổi") {
                if (age > 60) {
                    fee = 200; // Fixed fee for senior citizens
                } else {
                    return null; // Invalid age for "Người cao tuổi"
                }
            } else {
                return null; // Undefined gender
            }
            return fee;
        }

        // Handle the calculate button
        $(".btn-calculate").on("click", function() {
            const form = $("#registrationForm")[0];

            // Reset previous validation states
            form.classList.remove('was-validated');
            // Get form values
            const name = $("#name").val().trim();
            const address = $("#address").val().trim();
            const phone = $("#phone").val().trim();
            const cccd = $("#cccd").val().trim();

            // Get form values
            const gender = $('input[name="gender"]:checked').val();
            const age = parseInt($("#age").val(), 10);// Validate all fields before calculating fee
            if (!validateName(name)) {
                alert("Tên không hợp lệ! Vui lòng kiểm tra lại.");
                return; // Stop processing
            }

            if (!validateAddress(address)) {
                alert("Địa chỉ không hợp lệ! Vui lòng kiểm tra lại.");
                return; // Stop processing
            }

            if (!validatePhone(phone)) {
                alert("Số điện thoại không hợp lệ! Vui lòng kiểm tra lại.");
                return; // Stop processing
            }

            if (!validateCCCD(cccd)) {
                alert("Số CCCD không hợp lệ! Vui lòng kiểm tra lại.");
                return; // Stop processing
            }

            if (!validateAge(age)) {
                alert("Tuổi không hợp lệ! Vui lòng kiểm tra lại.");
                return; // Stop processing
            }

            // Validate required fields before calculation
            if (form.checkValidity()) {
                const fee = calculateFee(gender, age);
                if (fee !== null) {
                    $("#fee").val(fee + " VND");
                    alert("Giá tiền ước tính: " + fee + " VND");
                } else {
                    alert("Thông tin không hợp lệ. Vui lòng kiểm tra lại giới tính và độ tuổi.");
                }
            } else {
                form.classList.add('was-validated');
            }
        });

        // Highlight fields based on validity on input change
        $("#registrationForm input, #registrationForm select").on("input change", function() {
            const input = $(this);
            if (input[0].checkValidity()) {
                input.removeClass("is-invalid").addClass("is-valid");
            } else {
                input.removeClass("is-valid").addClass("is-invalid");
            }
        });

        // Handle form submission
        $("#registrationForm").on("submit", function(event) {
            event.preventDefault();
            if (this.checkValidity()) {
                alert("Đăng ký thành công!");
            } else {
                this.classList.add('was-validated');
            }
        });

        // Handle refresh button
        $(".btn-refresh").on("click", function() {
            $("#fee").val("VND"); // Reset fee
            $("#registrationForm").removeClass('was-validated'); // Clear validation state
        });

        // Handle exit button
        $(".btn-exit").on("click", function() {
            window.close(); // Close the current window
        });
    });
</script>

</body>
</html>
